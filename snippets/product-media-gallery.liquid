{% assign id = section.id %}
{% capture items %}
    {% for media in product.media %}
        <li class="keen-slider__slide keen-slider-{{id}}-keen-slider__slide">
            <div class="">
                <img id="{{ product.id }}" class="product__image tw-absolute tw-inset-0 tw-w-full tw-h-full tw-object-contain lazyload lazyload-fade" src="{{ media | img_url: '800x' }}" data-src="{{ img_url }}" data-sizes="auto" data-zoom-src="{{ media | img_url: '2400x' }}" data-aspectratio="{{ media.preview_image.aspect_ratio }}" alt="{{ media.alt | escape }}">
            </div>
            <noscript>
                <img id="{{ product.id }}" class="product-main-image" src="{{ featured_media | img_url: '800x' }}" alt='{{ media.alt | escape }}'/>
            </noscript>
        </li>

    {% endfor %}
{% endcapture %}

{% capture dots %}
    {% for media in product.media %}
        <div class="dot tw-border-none lg:tw-border lg:tw-border-solid tw-border-current hover:tw-border-black lg:tw-bg-transparent tw-bg-current  tw-w-[5px] tw-h-[5px] tw-rounded-full lg:tw-w-[54px] lg:tw-h-[31px] lg:tw-rounded-none">
            <div class="tw-hidden lg:tw-block tw-w-full tw-h-full">
                <img class="tw-w-full tw-h-full product__image tw-object-contain" src="{{ media | img_url: '150x' }}" data-src="{{ img_url }}" data-sizes="auto" data-image-id="{{ media.id }}" alt="{{ media.alt | escape }}">
            </div>
            <noscript>
                <img src="{{ media | img_url: '100x' }}" alt="{{ media.alt | escape }}"/>
            </noscript>
        </div>
    {% endfor %}
{% endcapture %}
{% for variant in product.variants %}
    {% assign optionStr = variant.title %}
    <template data-variant-id="{{variant.id}}" data-optionstr="{{optionStr}}">
        {% for media in product.media %}
                {% if optionStr == media.alt %}
                <li class="keen-slider__slide keen-slider-{{id}}-keen-slider__slide">
                    <div class="">
                        <img class="product__image tw-absolute tw-inset-0 tw-w-full tw-h-full tw-object-contain lazyload lazyload-fade" src="{{ media | img_url: '800x' }}" data-src="{{ img_url }}" data-sizes="auto" data-zoom-src="{{ media | img_url: '2400x' }}" data-aspectratio="{{ media.preview_image.aspect_ratio }}" alt="{{ media.alt | escape }}">
                    </div>
                    <noscript>
                        <img class="product-main-image" src="{{ featured_media | img_url: '800x' }}" alt='{{ media.alt | escape }}'/>
                    </noscript>
                </li>
            {% endif %}
        {% endfor %}
    </template>
    <template data-variant-dot-id="{{variant.id}}">
        {% for media in product.media %}
            {% if optionStr == media.alt %}
                <div class="dot tw-border-none lg:tw-border lg:tw-border-solid tw-border-current hover:tw-border-black lg:tw-bg-transparent tw-bg-current  tw-w-[5px] tw-h-[5px] tw-rounded-full lg:tw-w-[54px] lg:tw-h-[31px] lg:tw-rounded-none">
                    <div class="tw-hidden lg:tw-block tw-w-full tw-h-full">
                        <img class="tw-w-full tw-h-full product__image tw-object-contain" src="{{ media | img_url: '150x' }}" data-src="{{ img_url }}" data-sizes="auto" data-image-id="{{ media.id }}" alt="{{ media.alt | escape }}">
                    </div>
                    <noscript>
                        <img src="{{ media | img_url: '100x' }}" alt="{{ media.alt | escape }}"/>
                    </noscript>
                </div>
            {% endif %}
        {% endfor %}
    </template>
{% endfor %}

{% if id %}
    {% else %}
        {% assign id = section.id %}
{% endif %}
<div class="tw-relative tw-py-6">
    <div class="keen-slider tw-h-[220px] sm:tw-h-[300px] lg:tw-h-[600px]" id="keen-slider-{{id}}">
        {{items}}
    </div>
    <div class=" tw-mt-6 keen-slider-{{id}}-dots tw-gap-2 tw-flex-wrap " id="keen-slider-{{id}}-dots">
        {{dots}}
    </div>
    <div class="tw-hidden tw-pointer-events-none tw-px-8 lg:tw-flex tw-items-center tw-justify-between tw-absolute tw-h-full tw-top-0 tw--left-8 tw--right-8">
        <button class="tw-m-0 tw-pointer-events-auto !tw-text-2xl tw-text-black tw-bg-transparent tw-w-10 tw-h-10 tw-rounded-full tw-flex tw-justify-center tw-items-center hover:tw-bg-gray-100" id="keen-slider-{{id}}-arrow-left">
            <svg height="1em" viewbox="0 0 100 100" width="1em">
                <path class="arrow" d="M 10,50 L 50,90 L 55,90 L 15,50  L 55,10 L 50,10 Z"></path>
            </svg>
        </button>
        <div class="tw-flex-1"></div>
        <button class="tw-m-0 tw-pointer-events-auto  !tw-text-2xl tw-text-black tw-bg-transparent tw-w-10 tw-h-10 tw-rounded-full tw-flex tw-justify-center tw-items-center hover:tw-bg-gray-100" id="keen-slider-{{id}}-arrow-right">
            <svg height="1em" viewbox="0 0 100 100" width="1em">
                <path class="arrow" d="M 10,50 L 50,90 L 55,90 L 15,50  L 55,10 L 50,10 Z" transform="translate(100, 100) rotate(180) "></path>
            </svg>
        </button>
    </div>

</div>

<style>
    .keen-slider {
        display: flex;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
        -khtml-user-select: none;
        touch-action: pan-y;
        -webkit-tap-highlight-color: transparent;
    }
    .keen-slider,
    .keen-slider>* {
        overflow: hidden;
        position: relative;
    }
    .keen-slider>* {
        width: 100%;
        min-height: 100%;
    }
    .keen-slider[data-keen-slider-v] {
        flex-wrap: wrap;
    }
    .keen-slider[data-keen-slider-v]>* {
        width: 100%;
    }

    .keen-slider[data-keen-slider-moves] * {
        pointer-events: none;
    }

    .keen-slider>* {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 50px;
        font-weight: 500;
        height: 100%;
    }
    .keen-slider-{{id}}-dots{
      display: flex; 
      justify-content: center;
      overflow: hidden;
      padding-bottom: 2em;
    }
    .keen-slider-{{id}}-dots .dot{
      color: #cecece;
      overflow: hidden;
    }
    .keen-slider-{{id}}-dots .dot--active{
      color: #000;
    }
    .arrow--disabled{
        display: none;
    }
</style>
<script>
    window.addEventListener("themeloaded", function(event) { // (1)
        const slider = new KeenSlider("#keen-slider-{{id}}", {
          slidesPerView: 1,
          spacing: 0,
          loop: true,
          created: function (instance) {
              window.slider=instance
                Events.on('variantchange', function(variant,product, context){
                    console.log({variant,product, context})
                    if(variant){
                        document.querySelector("#keen-slider-{{id}}").innerHTML=''
                        const innerslider =document.querySelector(`[data-variant-id='${variant.id}']`).content.cloneNode(true)
                        console.log(innerslider)
                        document.querySelector("#keen-slider-{{id}}").append(innerslider)
                        updateDots(instance,variant)
                        instance.refresh()
                    }
                    window.slider.moveToSlide(0)
                })
              document
              .getElementById("keen-slider-{{id}}-arrow-left")
              .addEventListener("click", function () {
                  instance.prev()
              })

              document
              .getElementById("keen-slider-{{id}}-arrow-right")
              .addEventListener("click", function () {
                  instance.next()
              })
              
              updateClasses(instance)
              updateDots(instance)
          },
          slideChanged(instance) {
              updateClasses(instance)
          },
      })
      function updateClasses(instance) {
          var slide = instance.details().relativeSlide
          var arrowLeft = document.getElementById("keen-slider-{{id}}-arrow-left")
          var arrowRight = document.getElementById("keen-slider-{{id}}-arrow-right")
          slide === 0
              ? arrowLeft.classList.add("arrow--disabled")
              : arrowLeft.classList.remove("arrow--disabled")
          slide === instance.details().size - 1
              ? arrowRight.classList.add("arrow--disabled")
              : arrowRight.classList.remove("arrow--disabled")
          var dots = document.querySelectorAll(".dot")
          dots.forEach(function (dot, idx) {
            idx === slide
              ? dot.classList.add("dot--active")
              : dot.classList.remove("dot--active")
          })
      }
      function updateDots(instance,variant) {
        if(!variant) return
        var dots_wrapper = document.getElementById("keen-slider-{{id}}-dots")
        dots_wrapper.innerHTML=''
              var dots = [...document.querySelector(`[data-variant-dot-id='${variant.id}']`).content.children]
            //   console.log(document.querySelector(`[data-variant-dot-id='${variant.id}']`))
              dots.forEach(function (e, idx) {
                var dot = e.cloneNode(true)
                dots_wrapper.appendChild(dot)
                dot.addEventListener("click", function () {
                    instance.moveToSlide(idx)
                })
              })
      }
  })

</script>
<script src="https://cdn.jsdelivr.net/npm/keen-slider@5.5.0/keen-slider.min.js" ></script>
